<!DOCTYPE html>
<html>
<head>
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<!-- Enable responsiveness on mobile devices-->
<!-- viewport-fit=cover is to support iPhone X rounded corners and notch in landscape-->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

<title>bjornruud.net</title>

<link rel="stylesheet" href="/print.css" media="print">
<link rel="stylesheet" href="/main.css">


<link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">


  
</head>

<body>
  <div class="flex-container">
    <div class="header-container">
      <div class="header">
        
        <div class="header-title">
  <a href="/">bjornruud.net</a>
</div>
<div class="header-subtitle">
  <a href="/atom.xml">rss</a> |
  <a href="/blog/archive/">archive</a>
</div>

        
      </div>
    </div>

    <div class="content-container">
      <div class="content">
        
<article>
  <div class="date">2012-05-26</div>
  <div class="post">
    <h1 id="autogenerated-build-information-in-xcode-4">Autogenerated build information in Xcode 4</h1>
<p>In the Xcode project settings there are &quot;Version&quot; and &quot;Build&quot; fields for each target. These are the <code>CFBundleShortVersionString</code> and <code>CFBundleVersion</code> fields respectively in the info plist. The Version field is the version identifier presented to the user, and is the one Apple cares about when submitting an app to the App Store. It should use a readable scheme like major.minor.micro, e.g. 1.0.2.</p>
<p>The Build field however can be whatever you want in order to identify a build: incrementing counter, revision, tag, etc. Many recipes for automatic versioning of an application target this field, but my requirements led to a slightly different solution. Those requirements were:</p>
<ul>
<li>Don't touch the info plist. I want to update Version and Build manually.</li>
<li>Store extra build info in separate file that is automatically generated and isn't tracked in repo. I don't want to clutter the repo with frequent build info changes.</li>
<li>Include at least build date and revision instead of just build. Other possible data fields could be branch, tag, user, host, etc. This is necessary because a distributed development environment without a dedicated place to create builds has no way to synchronize build numbers. It is also impossible to know who created the build.</li>
</ul>
<p>The first step to meet these requirements was to write a script, <code>setversion.sh</code>, which leverages the PlistBuddy tool to create and modify a plist:</p>
<pre data-lang="bash" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#608b4e;">#!/bin/bash</span><span style="color:#608b4e;">
</span><span>
</span><span>PLIST=</span><span style="background-color:#282828;color:#d69d85;">&quot;$</span><span style="background-color:#282828;color:#dcdcdc;">1</span><span style="background-color:#282828;color:#d69d85;">&quot;</span><span>
</span><span>
</span><span>HG=</span><span style="background-color:#282828;color:#d69d85;">/usr/local/bin/hg</span><span>
</span><span>PLISTBUDDY=</span><span style="background-color:#282828;color:#d69d85;">/usr/libexec/PlistBuddy</span><span>
</span><span>
</span><span>fields=(</span><span>
</span><span>    </span><span style="color:#d69d85;">&quot;BuildDate&quot; &quot;$(</span><span>date -u</span><span style="color:#d69d85;"> +&#39;%F %T&#39;)&quot;</span><span>
</span><span>    </span><span style="color:#d69d85;">&quot;BuildRevision&quot; &quot;$(</span><span>$HG</span><span style="color:#d69d85;"> identify </span><span style="color:#569cd6;">| </span><span>cut -d </span><span style="color:#d69d85;">&#39; &#39;</span><span> -f1</span><span style="color:#d69d85;">)&quot;</span><span>
</span><span>)</span><span>
</span><span>
</span><span style="color:#608b4e;"># Create empty plist if it doesn&#39;t exist, clear it if it does</span><span style="color:#608b4e;">
</span><span>$PLISTBUDDY -x -c </span><span style="color:#d69d85;">&quot;Clear dict&quot; &quot;$</span><span>PLIST</span><span style="color:#d69d85;">&quot;</span><span>
</span><span>
</span><span style="color:#608b4e;"># Add all fields to plist</span><span style="color:#608b4e;">
</span><span style="color:#569cd6;">for </span><span>((i=</span><span style="color:#b5cea8;">0</span><span>; i </span><span style="color:#569cd6;">&lt; </span><span>${#fields[*]}; i=i+</span><span style="color:#b5cea8;">2</span><span>))</span><span>
</span><span style="color:#569cd6;">do</span><span>
</span><span>    name=</span><span style="background-color:#282828;color:#d69d85;">${</span><span style="background-color:#282828;color:#dcdcdc;">fields[i]</span><span style="background-color:#282828;color:#d69d85;">}</span><span>
</span><span>    value=</span><span style="background-color:#282828;color:#d69d85;">${</span><span style="background-color:#282828;color:#dcdcdc;">fields[i+</span><span style="background-color:#282828;color:#b5cea8;">1</span><span style="background-color:#282828;color:#dcdcdc;">]</span><span style="background-color:#282828;color:#d69d85;">}</span><span>
</span><span>    $PLISTBUDDY -x -c </span><span style="color:#d69d85;">&quot;Add :$</span><span>name</span><span style="color:#d69d85;"> string </span><span style="color:#e3bbab;">\&quot;</span><span style="color:#d69d85;">$</span><span>value</span><span style="color:#e3bbab;">\&quot;</span><span style="color:#d69d85;">&quot; &quot;$</span><span>PLIST</span><span style="color:#d69d85;">&quot;</span><span>
</span><span style="color:#569cd6;">done</span><span>
</span></code></pre>
<p>The script adds two fields. BuildDate is the UTC timestamp of the build, and BuildRevision is the short form revision hash from the <a rel="noopener" target="_blank" href="http://mercurial.selenic.com/">Mercurial</a> repo. This script is not added to the Xcode project but is kept in the repo (or somewhere more suitable for easy access and sharing).</p>
<p>Next we need to generate a version plist so that we can add it to the project. Run the script in a shell with a suitable plist path and name as argument.</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>./setversion.sh MyProject-Version.plist</span><span>
</span></code></pre>
<p>Add the generated file to the Xcode project and make sure to mark the proper targets for it if you have more than one.</p>
<p>This file shouldn't be tracked in the repo so we add it to <code>.hgignore</code>:</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>*-Version.plist</span><span>
</span></code></pre>
<p>Next we configure the script to run for each build. Select your project in Xcode and go to &quot;Build Phases&quot; for the target you want to add version information to. Select &quot;Add Build Phase&quot; and choose &quot;Add Run Script&quot;. In the script text field add the path to the script with path to the version plist as argument.</p>
<pre data-lang="bash" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-bash "><code class="language-bash" data-lang="bash"><span>$SRCROOT/$PROJECT_NAME/setversion.sh </span><span style="color:#d69d85;">&quot;$</span><span>SRCROOT</span><span style="color:#d69d85;">/$</span><span>PROJECT_NAME</span><span style="color:#d69d85;">/$</span><span>PROJECT_NAME</span><span style="color:#d69d85;">-Version.plist&quot;</span><span>
</span></code></pre>
<p>Rename the build phase if you like and drag it up below &quot;Target Dependencies&quot; to make sure it runs before files are compiled and copied.</p>
<p>That's it! Whenever a build is done in Xcode the version plist will be generated and can be easily accessed:</p>
<pre data-lang="m" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-m "><code class="language-m" data-lang="m"><span>NSString </span><span style="color:#569cd6;">*</span><span>versionPath = [[NSBundle mainBundle] pathForResource</span><span style="color:#569cd6;">:</span><span style="color:#d69d85;">@&quot;MyProject-Version&quot;</span><span> ofType</span><span style="color:#569cd6;">:</span><span style="color:#d69d85;">@&quot;plist&quot;</span><span>];</span><span>
</span><span>NSDictionary </span><span style="color:#569cd6;">*</span><span>versionDict = [NSDictionary dictionaryWithContentsOfFile:versionPath];</span><span>
</span><span>NSString </span><span style="color:#569cd6;">*</span><span>buildDate = [versionDict objectForKey:</span><span style="color:#d69d85;">@&quot;BuildDate&quot;</span><span>];</span><span>
</span><span>NSString </span><span style="color:#569cd6;">*</span><span>revision = [versionDict objectForKey:</span><span style="color:#d69d85;">@&quot;BuildRevision&quot;</span><span>];</span><span>
</span></code></pre>

  </div>
</article>

      </div>
    </div>

    <div class="footer-container">
      <div class="footer">
        
        Bj√∏rn Olav Ruud &copy; 2022<br/>
<a href="https://github.com/BjornRuud">GitHub</a> | <a href="https://www.linkedin.com/in/bjornruud/">LinkedIn</a> | <a href="https://twitter.com/BjornRuud">Twitter</a><br/>
Built with <a href="https://www.getzola.org" target="_blank">Zola</a>

        
      </div>
    </div>
  </div>

  <script data-goatcounter="https://bjornruud.goatcounter.com/count"
  async src="//gc.zgo.at/count.js"></script>
</body>
</html>
